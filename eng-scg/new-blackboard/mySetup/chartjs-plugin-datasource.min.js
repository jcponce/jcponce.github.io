/*!
 * chartjs-plugin-datasource v0.1.0
 * https://nagix.github.io/chartjs-plugin-datasource
 * (c) 2019 Akihiko Kusanagi
 * Released under the MIT license
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("chart.js"),require("xlsx")):"function"==typeof define&&define.amd?define(["chart.js","xlsx"],t):(e=e||self).ChartDataSource=t(e.Chart,e.XLSX)}(this,function(e,t){"use strict";e=e&&e.hasOwnProperty("default")?e.default:e,t=t&&t.hasOwnProperty("default")?t.default:t;var a=e.helpers,n=function(e,t){this.initialize(e,t)};a.extend(n.prototype,{_defaultConfig:{},_responseType:null,initialize:function(e,t){this._chart=e,this._options=a.extend({},this._defaultConfig,t)},request:function(e){var t=this,a=t.getUrl(),n=new XMLHttpRequest;n.open("GET",a),n.responseType=t._responseType,n.onreadystatechange=function(){var a;4===n.readyState&&(200===n.status&&(a=t.convert(n.response)),e.call(t,{success:200===n.status,data:a}))},n.send()},convert:function(){},getType:function(){return this._options.type},getUrl:function(){return this._options.url}}),n.extend=a.inherits;var r=e.helpers,s={isObject:r.isObject||function(e){return null!==e&&"[object Object]"===Object.prototype.toString.call(e)},valueOrDefault:r.valueOrDefault||r.getValueOrDefault,getExtension:function(e){var t=e.match(/\.([0-9a-z]+)(?:[?#]|$)/i);if(t)return t[1]},transpose:function(e){var t,a,n,r=e[0].length,s=e.length,i=[];for(t=0;t<r;++t){for(n=[],a=0;a<s;++a)n.push(e[a][t]);i.push(n)}return i},dedup:function(e){return e.filter(function(t,a){return e.indexOf(t)===a})}},i=e.helpers;function o(e){return(e.shift()||[]).map(function(e){return s.valueOrDefault(e,"")})}function l(e){return e.map(function(e){return s.valueOrDefault(e.shift(),"")})}function d(e,t){return i.isFinite(e)&&e>=0&&Math.floor(e)===e?e:t.indexOf(e)}function u(e,t,a){var n,r,i=d(t,a),o=[];for(n=0,r=e.length;n<r;++n)o.push(e[n][i]);return s.dedup(o)}var p=n.extend({_defaultConfig:{type:"csv",rowMapping:"dataset",datasetLabels:!0,indexLabels:!0,datapointLabels:!0,datapointLabelMapping:{_dataset:"_dataset",_index:"x"}},_responseType:"text",initialize:function(){var e;n.prototype.initialize.apply(this,arguments),void 0===(e=this._options).delimiter&&(e.delimiter=function(e){switch(s.getExtension(e)){default:return",";case"tsv":return"\t";case"psv":return"|"}}(e.url))},convert:function(e){var t,a,n,r,i,p,f=this._options,c=function(e,t){for(var a,n,r,s,i=new RegExp("("+t+'|\r?\n(?!$)|\r(?!$)|^(?!$))(?:"((?:\\.|""|[^\\"])*)"|([^'+t+'"\r\n]*))',"gi"),o=[],l=[o],d=0;a=i.exec(e);)a[1]&&(a[1]!==t?(o=[],l.push(o)):1===l.length&&0===o.length&&o.push(void 0)),o.push(void 0!==a[2]?a[2].replace(/[\\"](.)/g,"$1"):a[3]?a[3]:void 0),d=Math.max(d,o.length);for(n=0,r=l.length;n<r;++n)for(s=(o=l[n]).length;s<d;++s)o.push(void 0);return l}(e,f.delimiter),h=[];switch(f.rowMapping){default:!0===f.indexLabels&&(n=o(c)),!0===f.datasetLabels&&(n&&n.shift(),a=l(c)),r=c;break;case"index":!0===f.datasetLabels&&(a=o(c)),!0===f.indexLabels&&(a&&a.shift(),n=l(c)),r=s.transpose(c);break;case"datapoint":!0===f.datapointLabels&&(t=o(c)),void 0===t&&(t=["_dataset","x","y","r"]),a=u(c,f.datapointLabelMapping._dataset,t),n=u(c,f.datapointLabelMapping._index,t),r=function(e,t,a){var n,r,s,i,o,l,d,u,p={},f=[];for(o=0,d=t.length;o<d;++o)p[t[o]]=o,f[o]=[];for(o=0,d=e.length;o<d;++o)for(r={},l=0,u=(n=e[o]).length;l<u;++l)s=a[l],i=n[l],"_dataset"===s?f[p[i]].push(r):r[s]=i;return f}(c,a,t=function(e,t){var a,n,r,s,i=Object.keys(t),o=e.slice();for(r=0,s=i.length;r<s;++r)-1!==(n=d(t[a=i[r]],e))&&"_index"!==a&&(o[n]=a);return o}(t,f.datapointLabelMapping))}for(a=a||[],i=0,p=r.length;i<p;++i)h.push({label:a[i],data:r[i]});return{labels:n,datasets:h}}});p._extensions=["csv","tsv","psv"];var f=e.helpers;function c(e,t){var a,n,r,i,o,l,d,u,p,h,g=/(?:,|^)\s*(?:"([^"]*)"|'([^']*)'|([^,\s]*))/gi,b=[];if(void 0===e||void 0===t)return e;if(a=t.match(/(?:\[((?:\[[^\]]*\]|[^\]])*)\]|([^.[]*))(\.?(.*))/)){if(n=a[1],r=a[2],o=(i=a[3])?a[4]:void 0,"*"===r||"*"===n){if(f.isArray(e))for(u=0,p=e.length;u<p;++u)b.push(c(e[u],o));else if(s.isObject(e))for(u=0,p=(h=b._labels=Object.keys(e)).length;u<p;++u)b.push(c(e[h[u]],o));return b}if(void 0!==r)return c(e[r],o);for(h=b._labels=[];a=g.exec(n);)d=void 0!==(l=s.valueOrDefault(a[1],a[2]))?c(e[l],o):c(e,a[3]+i),b.push(d),h.push(s.valueOrDefault(l,a[3]));return b.length>1?b:b[0]}}function h(e){var t,a,n,r,i,o=e.length,l=[];for(r=0;r<o;++r)Array.prototype.push.apply(l,e[r]._labels);for(n=(a=s.dedup(l)).length,r=0;r<o;++r){for(l=e[r],t=[],i=0;i<n;++i)t.push(l[l._labels.indexOf(a[i])]);e[r]=t}return a}function g(e,t){var a,n,r,i=[];for(n=0,r=e.length;n<r;++n)a=e[n]._labels,i.push(e[n][a?a.indexOf(t):t]);return s.dedup(i)}var b=n.extend({_defaultConfig:{type:"json",rowMapping:"dataset",datapointLabelMapping:{_dataset:"_dataset",_index:"x"}},_responseType:"json",convert:function(e){var t,a,n,r,i,o,l=this._options,d=[];switch(l.data&&(r=c(e,l.data)),l.rowMapping){default:l.datasetLabels?t=c(e,l.datasetLabels):r&&(t=r._labels),l.indexLabels?a=c(e,l.indexLabels):r&&(a=h(r)),n=r;break;case"index":l.datasetLabels?t=c(e,l.datasetLabels):r&&(t=h(r)),l.indexLabels?a=c(e,l.indexLabels):r&&(a=r._labels),r&&(n=s.transpose(r));break;case"datapoint":r&&(t=g(r,l.datapointLabelMapping._dataset),a=g(r,l.datapointLabelMapping._index),n=function(e,t,a){var n,r,i,o,l,d,u,p,f,c,h=Object.keys(a),g={},b={},v=[];for(u=0,f=h.length;u<f;++u)"_index"!==(o=h[u])&&(g[a[o]]=o);for(u=0,f=t.length;u<f;++u)b[t[u]]=u,v[u]=[];for(u=0,f=e.length;u<f;++u)for(r=(n=e[u])._labels,i={},p=0,c=n.length;p<c;++p)o=r?r[p]:p,l=s.valueOrDefault(g[o],o),d=n[p],"_dataset"===l?v[b[d]].push(i):i[l]=d;return v}(r,t,l.datapointLabelMapping))}for(t=t||[],n=n||[],i=0,o=Math.max(t.length,n.length);i<o;++i)d.push({label:t[i],data:n[i]});return{labels:a,datasets:d}}});b._extensions=["json"];var v=b.extend({_defaultConfig:{type:"jsonl",rowMapping:"index",datapointLabelMapping:{_dataset:"_dataset",_index:"x"}},_responseType:"text",convert:function(e){var t=JSON.parse("["+e.trim().split("\n").join(",")+"]");return b.prototype.convert.call(this,t)}});v._extensions=["jsonl"];var x=e.helpers;function _(e,a){for(var n,r,i,o,l,d,u;a;){if(a.match(/^(([A-Z]+\d*|[A-Z]*\d+):([A-Z]+\d*|[A-Z]*\d+)|[A-Z]+\d+)$/)){o=a;break}if(r)break;n=a.match(/^(?:'([^']*)'|([^!]*))(?:!(.*))?$/),r=s.valueOrDefault(n[1],n[2]),a=n[3]}return l=(i=e.Sheets[s.valueOrDefault(r,e.SheetNames[0])])?i["!ref"]:"",d=t.utils.decode_range(s.valueOrDefault(o,l)),l&&(u=t.utils.decode_range(l),-1===d.s.c&&(d.s={c:u.s.c,r:d.s.r}),-1===d.e.c&&(d.e={c:u.e.c,r:d.e.r}),isNaN(d.s.r)&&(d.s={c:d.s.c,r:u.s.r}),isNaN(d.e.r)&&(d.e={c:d.e.c,r:u.e.r})),{sheet:i,range:d,detected:void 0===o}}function y(e,a){var n,r,i,o,l,d,u,p=e.sheet,f=e.range,c=a&&a.columnOriented?"c":"r",h=a&&a.columnOriented?"r":"c",g=[];if(!p)return g;for(o=f.s[c],d=f.e[c];o<=d;++o){for(n=[],l=f.s[h],u=f.e[h];l<=u;++l)(r={})[c]=o,r[h]=l,i=(p[t.utils.encode_cell(r)]||{}).v,a&&a.header&&(i=s.valueOrDefault(i,"")),n.push(i);g.push(n.length>1?n:n[0])}return g}function L(e){var t=x.clone(e.range);if(!(t.s.r>=t.e.r))return t.e.r=t.s.r,e.range.s.r++,y({sheet:e.sheet,range:t},{columnOriented:!0,header:!0})}function O(e){var t=x.clone(e.range);if(!(t.s.c>=t.e.c))return t.e.c=t.s.c,e.range.s.c++,y({sheet:e.sheet,range:t},{header:!0})}function w(e,a,n){return e.match(/^[A-Z]+$/)?t.utils.decode_col(e)-n:a.indexOf(e)}function m(e,t,a){var n=x.clone(e.range),r=w(t,a,n.s.c);return n.s.c=n.e.c=-1!==r?r+n.s.c:r,s.dedup(y({sheet:e.sheet,range:n},{header:!0}))}var M=n.extend({_defaultConfig:{type:"sheet",rowMapping:"dataset",datapointLabelMapping:{_dataset:"_dataset",_index:"x"}},_responseType:"arraybuffer",initialize:function(){if(!t)throw new Error("XLSX is not found. Please load the xlsx library before loading this plugin.");n.prototype.initialize.apply(this,arguments)},convert:function(e){var a,n,r,i,o,l,d=this._options,u=t.read(new Uint8Array(e),{type:"array"}),p=_(u,s.valueOrDefault(d.data,"")),f=p.detected,c=[];switch(d.rowMapping){default:d.indexLabels?r=y(_(u,d.indexLabels),{columnOriented:!0,header:!0}):f&&(r=L(p)),d.datasetLabels?n=y(_(u,d.datasetLabels),{header:!0}):f&&(r&&r.shift(),n=O(p)),i=y(p);break;case"index":d.datasetLabels?n=y(_(u,d.datasetLabels),{columnOriented:!0,header:!0}):f&&(n=L(p)),d.indexLabels?r=y(_(u,d.indexLabels),{header:!0}):f&&(n&&n.shift(),r=O(p)),i=y(p,{columnOriented:!0});break;case"datapoint":d.datapointLabels?a=y(_(u,d.datapointLabels),{columnOriented:!0,header:!0}):f&&(a=L(p)),void 0===a&&(a=["_dataset","x","y","r"]),n=m(p,d.datapointLabelMapping._dataset,a),r=m(p,d.datapointLabelMapping._index,a),a=function(e,t){var a,n,r,s,i=Object.keys(t),o=e.slice();for(r=0,s=i.length;r<s;++r)-1!==(n=w(t[a=i[r]],e))&&"_index"!==a&&(o[n]=a);return o}(a,d.datapointLabelMapping),i=function(e,t,a){var n,r,s,i,o,l,d,u,p={},f=[];for(o=0,d=t.length;o<d;++o)p[t[o]]=o,f[o]=[];for(o=0,d=e.length;o<d;++o)for(r={},l=0,u=(n=e[o]).length;l<u;++l)s=a[l],i=n[l],"_dataset"===s?f[p[i]].push(r):r[s]=i;return f}(y(p),n,a)}for(n=n||[],i=i||[],o=0,l=Math.max(n.length,i.length);o<l;++o)c.push({label:n[o],data:i[o]});return{labels:r,datasets:c}}});M._extensions=["xlsx","xlsm","xlsb","xls","xlw","xml","csv","txt","dif","sylk","slk","prn","ods","fods","uos","dbf","wks","wk1","wk2","wk3","wk4","123","wq1","wq2","wb1","wb2","wb3","qpw","html","htm","eth"];var j={csv:p,json:b,jsonl:v,sheet:M},k=e.helpers;e.defaults.global.plugins.datasource={};var D={id:"datasource",beforeInit:function(e){e.$datasource={}},beforeUpdate:function(e,t){var a=e.$datasource,n=t.url,r=t.type||this.getType(n),i=this.getConstructor(r),o=a._datasource;if(n&&i&&!e.$datasource._delayed)return o&&o.getType()===r&&o.getUrl()===n||(o=a._datasource=new i(e,t)),o.request(function(t){!function(e,t){var a,n,r,i,o,l,d=t.datasets,u=e.datasets,p=t.labels,f=e.labels,c=0;if(k.isArray(d))for(k.isArray(u)||(u=e.datasets=[]),o=0,l=d.length;o<l;++o)a=d[o],n=u[o],s.isObject(n)||(n=u[o]={}),void 0!==(r=a.label)?n.label=r:void 0===n.label&&(n.label="Dataset "+(o+1)),i=a.data,k.isArray(i)&&(n.data=i,c=Math.max(c,i.length));if(k.isArray(p))e.labels=p;else if(!k.isArray(f)||!f.length)for(f=e.labels=[],o=0;o<c;++o)f[o]=""+(o+1)}(e.data,t.data),a._delayed=!0,e.update(),delete a._delayed}),!1},constructors:{},extensions:{},register:function(e,t,a){var n=this;n.constructors[e]=t,k.each(a,function(t){n.extensions[t]=e})},getType:function(e){if(e)return this.extensions[s.getExtension(e)]||"json"},getConstructor:function(e){if(!this.constructors.hasOwnProperty(e))throw new Error('"'+e+'" is not a data source type.');return this.constructors[e]}};return e.helpers.each(j,function(e,t){D.register(t,e,e._extensions,e._defaults)}),D});

/*!
 Author: Juan Carlos Ponce Campuzano
 https://www.dynamicmath.xyz
 Date: 24/08/2025
 Under Creative Commons Attribution, Non-Commercial, Share-Alike license
 http://creativecommons.org/licenses/by-nc-sa/4.0/
*/
import*as THREE from"three";import{OrbitControls}from"three/addons/controls/OrbitControls.js";const container=document.getElementById("app"),renderer=new THREE.WebGLRenderer({antialias:!0,alpha:!0});renderer.setPixelRatio(Math.min(window.devicePixelRatio,2)),renderer.setSize(window.innerWidth,window.innerHeight),container.appendChild(renderer.domElement);const scene=new THREE.Scene;scene.fog=new THREE.FogExp2(725024,.015);const camera=new THREE.PerspectiveCamera(55,window.innerWidth/window.innerHeight,.01,200);camera.position.set(2.5,4,1.5),camera.up.set(0,0,1);const controls=new OrbitControls(camera,renderer.domElement);controls.enableDamping=!0,controls.target.set(0,0,0);const ambient=new THREE.AmbientLight(16777215,.5);scene.add(ambient);const dir=new THREE.DirectionalLight(16777215,2.5);dir.position.set(4,4,8),scene.add(dir);const grid=new THREE.GridHelper(20,20,10992101,1846351);grid.material.opacity=.84,grid.material.transparent=!0,grid.rotation.x=Math.PI/2,scene.add(grid),grid.visible=!1;const axesHelper=new THREE.AxesHelper(1);scene.add(axesHelper),axesHelper.visible=!1;const sphereGeo=new THREE.SphereGeometry(1,48,32),sphereMat=new THREE.MeshStandardMaterial({color:2244762,roughness:.35,metalness:.1,transparent:!0,opacity:.65,emissive:463918,emissiveIntensity:.2,side:THREE.DoubleSide}),sphere=new THREE.Mesh(sphereGeo,sphereMat);scene.add(sphere);const pickMarkers=new THREE.Group;scene.add(pickMarkers);const markerGeo=new THREE.SphereGeometry(.035,16,16),markerMat=new THREE.MeshStandardMaterial({color:11849983,emissive:2245768,emissiveIntensity:.5}),params={waves:4,amplitude:.25,segments:240},toggleFibers=document.getElementById("toggle-fibers");toggleFibers.addEventListener("change",(function(){fibers.visible=this.checked}));let sphereVisible=!0;const toggleSphere=document.getElementById("toggle-sphere");toggleSphere.addEventListener("change",(function(){sphere.visible=this.checked,sphereVisible=this.checked,sphereVisible||(selectionMarker.style.display="none",selectedPoint=null)}));const togglePoints=document.getElementById("toggle-points");togglePoints.addEventListener("change",(function(){pickMarkers.visible=this.checked}));const toggleAxes=document.getElementById("toggle-axes");toggleAxes.addEventListener("change",(function(){axesHelper.visible=this.checked}));const toggleGrid=document.getElementById("toggle-grid");toggleGrid.addEventListener("change",(function(){grid.visible=this.checked})),document.getElementById("clear-btn").addEventListener("click",clearFibers);const examplesDropdown=document.getElementById("examples");function saveCurrentView(){renderer.render(scene,camera);const e=renderer.domElement.toDataURL("image/png"),t=document.createElement("a");t.href=e;const n=(new Date).toISOString().replace(/[:.]/g,"-");t.download=`hopf_view_${n}.png`,t.click()}examplesDropdown.addEventListener("change",(function(){"custom"!==this.value&&loadExample(this.value)})),document.getElementById("save-view-btn").addEventListener("click",saveCurrentView);const shareBtn=document.getElementById("share-link-btn");shareBtn.addEventListener("click",(()=>{const e={fibers:pickMarkers.children.map((e=>e.position.clone().normalize().toArray())),toggles:{fibers:toggleFibers.checked,sphere:toggleSphere.checked,points:togglePoints.checked,axes:toggleAxes.checked,grid:toggleGrid.checked},example:examplesDropdown.value},t=JSON.stringify(e),n=btoa(t),o=`${window.location.origin}${window.location.pathname}#${n}`;navigator.clipboard.writeText(o).then((()=>{alert("Shareable link copied to clipboard!")}))})),window.addEventListener("load",(()=>{if(window.location.hash.length>1)try{const e=window.location.hash.slice(1),t=atob(e),n=JSON.parse(t);examplesDropdown.value=n.example,"custom"!==n.example&&loadExample(n.example),toggleFibers.checked=n.toggles.fibers,fibers.visible=n.toggles.fibers,toggleSphere.checked=n.toggles.sphere,sphere.visible=n.toggles.sphere,togglePoints.checked=n.toggles.points,pickMarkers.visible=n.toggles.points,toggleAxes.checked=n.toggles.axes,axesHelper.visible=n.toggles.axes,toggleGrid.checked=n.toggles.grid,grid.visible=n.toggles.grid,"custom"===n.example&&(clearFibers(),n.fibers.forEach((e=>{addFiber(new THREE.Vector3(...e))})))}catch(e){console.error("Invalid state in URL:",e)}}));const modalBtn=document.getElementById("modal-btn"),modal=document.getElementById("info-modal"),overlay=document.getElementById("info-modal-overlay"),closeBtn=document.getElementById("close-modal");modalBtn.addEventListener("click",(()=>{modal.style.display="block",overlay.style.display="block"})),closeBtn.addEventListener("click",(()=>{modal.style.display="none",overlay.style.display="none"})),overlay.addEventListener("click",(()=>{modal.style.display="none",overlay.style.display="none"})),document.addEventListener("keydown",(e=>{"Escape"===e.key&&(modal.style.display="none",overlay.style.display="none")}));const controlsElement=document.getElementById("controls"),toggleControlsBtn=document.getElementById("toggle-controls-btn");let controlsVisible=!0;function spinorFromN(e){const t=e.z,n=2*Math.sqrt((1+t)/2);if(n>1e-8){return{z1:{re:Math.sqrt((1+t)/2),im:0},z2:{re:e.x/n,im:e.y/n}}}return{z1:{re:0,im:0},z2:{re:0,im:1}}}function rotatePhase(e,t){const n=Math.cos(t),o=Math.sin(t);return{re:e.re*n-e.im*o,im:e.re*o+e.im*n}}function stereoProjectS3ToR3(e,t,n,o){const r=1/(1-o);return new THREE.Vector3(e*r,t*r,n*r)}function hopfFiberPoints(e,t){const{z1:n,z2:o}=spinorFromN(e),r=[];for(let e=0;e<t;e++){const s=e/t*Math.PI*2,i=rotatePhase(n,s),a=rotatePhase(o,s),l=stereoProjectS3ToR3(i.re,i.im,a.re,a.im);r.push(l)}return r}toggleControlsBtn.addEventListener("click",(function(){controlsVisible=!controlsVisible,controlsVisible?(controlsElement.classList.remove("hidden"),toggleControlsBtn.textContent="▼ Hide Controls"):(controlsElement.classList.add("hidden"),toggleControlsBtn.textContent="▲ Controls")}));const fibers=new THREE.Group;function clearFibers(){for(;fibers.children.length>0;){const e=fibers.children[0];e.traverse((e=>{e.geometry&&e.geometry.dispose(),e.material&&(Array.isArray(e.material)?e.material.forEach((e=>e.dispose())):e.material.dispose())})),fibers.remove(e)}for(;pickMarkers.children.length>0;){const e=pickMarkers.children[0];e.geometry&&e.geometry.dispose(),e.material&&e.material.dispose(),pickMarkers.remove(e)}examplesDropdown.value="custom"}function addFiber(e){const t=params.segments,n=hopfFiberPoints(e,t),o=new THREE.CatmullRomCurve3(n,!0),r=new THREE.TubeGeometry(o,2*t,.02,12,!0),s=new THREE.MeshStandardMaterial({color:(new THREE.Color).setHSL(.4+.8*Math.random(),.9,.5),roughness:.3,metalness:.2,emissive:1127253,emissiveIntensity:.5}),i=new THREE.Mesh(r,s);fibers.add(i);const a=new THREE.Mesh(markerGeo,markerMat);a.position.copy(e.clone().multiplyScalar(1.001)),pickMarkers.add(a)}function loadExample(e){if(clearFibers(),"latitude-bands"===e){const e=6,t=80;for(let n=1;n<e;n++){const o=n/e*Math.PI-Math.PI/2,r=Math.sin(o),s=Math.cos(o);for(let e=0;e<t;e++){const n=e/t*Math.PI+Math.PI-.45*Math.PI,o=s*Math.cos(n),i=s*Math.sin(n);addFiber(new THREE.Vector3(o,i,r).normalize())}}}else if("spiral"===e){const e=100;for(let t=0;t<e;t++){const n=t/e,o=n*Math.PI*4,r=Math.acos(1-2*n),s=Math.sin(r)*Math.cos(o),i=Math.sin(r)*Math.sin(o),a=Math.cos(r);addFiber(new THREE.Vector3(s,i,a).normalize())}}else if("icosahedral"===e){const e=(1+Math.sqrt(5))/2,t=[[-1,e,0],[1,e,0],[-1,-e,0],[1,-e,0],[0,-1,e],[0,1,e],[0,-1,-e],[0,1,-e],[e,0,-1],[e,0,1],[-e,0,-1],[-e,0,1]];for(let e of t){addFiber(new THREE.Vector3(e[0],e[1],e[2]).normalize())}}else if("longitude-bands"===e){const e=4,t=40;for(let n=0;n<e;n++){const o=n/e*Math.PI*2,r=Math.cos(o),s=Math.sin(o);for(let e=0;e<t;e++){const n=(e/(t-1)+Math.PI/8)*Math.PI/2,o=Math.sin(n)*r,i=Math.sin(n)*s,a=Math.cos(n);addFiber(new THREE.Vector3(o,i,a).normalize())}}}else if("equator-sine"===e){const e=200,t=.3,n=5;for(let o=0;o<e;o++){const r=o/e*Math.PI*2,s=Math.cos(r),i=Math.sin(r),a=t*Math.sin(n*r);addFiber(new THREE.Vector3(s,i,a).normalize())}}}scene.add(fibers);const raycaster=new THREE.Raycaster,mouse=new THREE.Vector2;let selectedPoint=null;const selectionMarker=document.getElementById("selection-marker");function onMouseMove(e){if(!sphereVisible)return selectedPoint=null,void(selectionMarker.style.display="none");mouse.x=e.clientX/window.innerWidth*2-1,mouse.y=-e.clientY/window.innerHeight*2+1,raycaster.setFromCamera(mouse,camera);const t=raycaster.intersectObject(sphere,!1)[0];if(t){selectedPoint=t.point.clone().normalize();const e=selectedPoint.clone();e.project(camera);const n=(.5*e.x+.5)*window.innerWidth,o=-(.5*e.y-.5)*window.innerHeight;selectionMarker.style.left=`${n}px`,selectionMarker.style.top=`${o}px`,selectionMarker.style.display="block"}else selectedPoint=null,selectionMarker.style.display="none"}function onKeyDown(e){"a"!==e.key&&"A"!==e.key||selectedPoint&&(addFiber(selectedPoint),examplesDropdown.value="custom"),"h"!==e.key&&"H"!==e.key||toggleControlsBtn.click(),"s"!==e.key&&"S"!==e.key||saveCurrentView()}function render(){controls.update(),renderer.setClearColor(725024,1),renderer.clear(!0,!0,!0),renderer.render(scene,camera),requestAnimationFrame(render)}function onResize(){renderer.setSize(window.innerWidth,window.innerHeight),camera.aspect=window.innerWidth/window.innerHeight,camera.updateProjectionMatrix()}window.addEventListener("mousemove",onMouseMove),window.addEventListener("keydown",onKeyDown),render(),window.addEventListener("resize",onResize),addFiber(new THREE.Vector3(0,0,1)),addFiber(new THREE.Vector3(1,0,0).normalize()),addFiber(new THREE.Vector3(0,1,0).normalize());
/*!
 Author: Juan Carlos Ponce Campuzano
 https://www.dynamicmath.xyz
 Date: 24/08/2025
 Under Creative Commons Attribution, Non-Commercial, Share-Alike license
 http://creativecommons.org/licenses/by-nc-sa/4.0/
*/
import*as e from"three";import{OrbitControls as t}from"three/addons/controls/OrbitControls.js";let container=document.getElementById("app"),renderer=new e.WebGLRenderer({antialias:!0,alpha:!0});renderer.setPixelRatio(Math.min(window.devicePixelRatio,2)),renderer.setSize(window.innerWidth,window.innerHeight),container.appendChild(renderer.domElement);let scene=new e.Scene;scene.fog=new e.FogExp2(725024,.015);let camera=new e.PerspectiveCamera(55,window.innerWidth/window.innerHeight,.01,200);camera.position.set(2.5,4,1.5),camera.up.set(0,0,1);let controls=new t(camera,renderer.domElement);controls.enableDamping=!0,controls.target.set(0,0,0);let ambient=new e.AmbientLight(16777215,.5);scene.add(ambient);let dir=new e.DirectionalLight(16777215,2.5);dir.position.set(4,4,8),scene.add(dir);let grid=new e.GridHelper(20,20,10992101,1846351);grid.material.opacity=.84,grid.material.transparent=!0,grid.rotation.x=Math.PI/2,scene.add(grid),grid.visible=!1;let axesHelper=new e.AxesHelper(1);scene.add(axesHelper),axesHelper.visible=!1;let sphereGeo=new e.SphereGeometry(1,48,32),sphereMat=new e.MeshStandardMaterial({color:2244762,roughness:.35,metalness:.1,transparent:!0,opacity:.65,emissive:463918,emissiveIntensity:.2,side:e.DoubleSide}),sphere=new e.Mesh(sphereGeo,sphereMat);scene.add(sphere);let pickMarkers=new e.Group;scene.add(pickMarkers);let markerGeo=new e.SphereGeometry(.035,16,16),markerMat=new e.MeshStandardMaterial({color:11849983,emissive:2245768,emissiveIntensity:.5}),params={waves:4,amplitude:.25,segments:240},toggleFibers=document.getElementById("toggle-fibers");toggleFibers.addEventListener("change",function(){fibers.visible=this.checked});let sphereVisible=!0,toggleSphere=document.getElementById("toggle-sphere");toggleSphere.addEventListener("change",function(){sphere.visible=this.checked,(sphereVisible=this.checked)||(selectionMarker.style.display="none",selectedPoint=null)});let togglePoints=document.getElementById("toggle-points");togglePoints.addEventListener("change",function(){pickMarkers.visible=this.checked});let toggleAxes=document.getElementById("toggle-axes");toggleAxes.addEventListener("change",function(){axesHelper.visible=this.checked});let toggleGrid=document.getElementById("toggle-grid");toggleGrid.addEventListener("change",function(){grid.visible=this.checked}),document.getElementById("clear-btn").addEventListener("click",clearFibers);let examplesDropdown=document.getElementById("examples");function saveCurrentView(){renderer.render(scene,camera);let e=renderer.domElement.toDataURL("image/png"),t=document.createElement("a");t.href=e;let r=new Date().toISOString().replace(/[:.]/g,"-");t.download=`hopf_view_${r}.png`,t.click()}examplesDropdown.addEventListener("change",function(){"custom"!==this.value&&loadExample(this.value)}),document.getElementById("save-view-btn").addEventListener("click",saveCurrentView);let shareBtn=document.getElementById("share-link-btn");shareBtn.addEventListener("click",()=>{let e={fibers:pickMarkers.children.map(e=>e.position.clone().normalize().toArray()),toggles:{fibers:toggleFibers.checked,sphere:toggleSphere.checked,points:togglePoints.checked,axes:toggleAxes.checked,grid:toggleGrid.checked},example:examplesDropdown.value},t=JSON.stringify(e),r=btoa(t),n=`${window.location.origin}${window.location.pathname}#${r}`;navigator.clipboard.writeText(n).then(()=>{alert("Shareable link copied to clipboard!")})}),window.addEventListener("load",()=>{if(window.location.hash.length>1)try{let t=window.location.hash.slice(1),r=atob(t),n=JSON.parse(r);examplesDropdown.value=n.example,"custom"!==n.example&&loadExample(n.example),toggleFibers.checked=n.toggles.fibers,fibers.visible=n.toggles.fibers,toggleSphere.checked=n.toggles.sphere,sphere.visible=n.toggles.sphere,togglePoints.checked=n.toggles.points,pickMarkers.visible=n.toggles.points,toggleAxes.checked=n.toggles.axes,axesHelper.visible=n.toggles.axes,toggleGrid.checked=n.toggles.grid,grid.visible=n.toggles.grid,"custom"===n.example&&(clearFibers(),n.fibers.forEach(t=>{addFiber(new e.Vector3(...t))}))}catch(i){console.error("Invalid state in URL:",i)}});let modalBtn=document.getElementById("modal-btn"),modal=document.getElementById("info-modal"),overlay=document.getElementById("info-modal-overlay"),closeBtn=document.getElementById("close-modal");modalBtn.addEventListener("click",()=>{modal.style.display="block",overlay.style.display="block"}),closeBtn.addEventListener("click",()=>{modal.style.display="none",overlay.style.display="none"}),overlay.addEventListener("click",()=>{modal.style.display="none",overlay.style.display="none"}),document.addEventListener("keydown",e=>{"Escape"===e.key&&(modal.style.display="none",overlay.style.display="none")});let controlsElement=document.getElementById("controls"),toggleControlsBtn=document.getElementById("toggle-controls-btn"),controlsVisible=!0;function spinorFromN(e){let t=e.z,r=2*Math.sqrt((1+t)/2);if(!(r>1e-8))return{z1:{re:0,im:0},z2:{re:0,im:1}};{let n={re:e.x/r,im:e.y/r};return{z1:{re:Math.sqrt((1+t)/2),im:0},z2:n}}}function rotatePhase(e,t){let r=Math.cos(t),n=Math.sin(t);return{re:e.re*r-e.im*n,im:e.re*n+e.im*r}}function stereoProjectS3ToR3(t,r,n,i){let s=1/(1-i);return new e.Vector3(t*s,r*s,n*s)}function hopfFiberPoints(e,t){let{z1:r,z2:n}=spinorFromN(e),i=[];for(let s=0;s<t;s++){let l=s/t,o=l*Math.PI*2,a=rotatePhase(r,o),d=rotatePhase(n,o),c=stereoProjectS3ToR3(a.re,a.im,d.re,d.im);i.push(c)}return i}toggleControlsBtn.addEventListener("click",function(){(controlsVisible=!controlsVisible)?(controlsElement.classList.remove("hidden"),toggleControlsBtn.textContent="▼ Hide Controls"):(controlsElement.classList.add("hidden"),toggleControlsBtn.textContent="▲ Controls")});let fibers=new e.Group;function clearFibers(){for(;fibers.children.length>0;){let e=fibers.children[0];e.traverse(e=>{e.geometry&&e.geometry.dispose(),e.material&&(Array.isArray(e.material)?e.material.forEach(e=>e.dispose()):e.material.dispose())}),fibers.remove(e)}for(;pickMarkers.children.length>0;){let t=pickMarkers.children[0];t.geometry&&t.geometry.dispose(),t.material&&t.material.dispose(),pickMarkers.remove(t)}examplesDropdown.value="custom"}function addFiber(t){let r=params.segments,n=hopfFiberPoints(t,r),i=new e.CatmullRomCurve3(n,!0),s=new e.TubeGeometry(i,2*r,.02,12,!0),l=new e.MeshStandardMaterial({color:new e.Color().setHSL(.4+.8*Math.random(),.9,.5),roughness:.3,metalness:.2,emissive:1127253,emissiveIntensity:.5}),o=new e.Mesh(s,l);fibers.add(o);let a=new e.Mesh(markerGeo,markerMat);a.position.copy(t.clone().multiplyScalar(1.001)),pickMarkers.add(a)}function loadExample(t){if(clearFibers(),"latitude-bands"===t)for(let r=1;r<6;r++){let n=r/6*Math.PI-Math.PI/2,i=Math.sin(n),s=Math.cos(n);for(let l=0;l<80;l++){let o=l/80*Math.PI+Math.PI-.45*Math.PI,a=s*Math.cos(o),d=s*Math.sin(o);addFiber(new e.Vector3(a,d,i).normalize())}}else if("spiral"===t)for(let c=0;c<100;c++){let g=c/100,m=g*Math.PI*4,p=Math.acos(1-2*g),$=Math.sin(p)*Math.cos(m),h=Math.sin(p)*Math.sin(m),y=Math.cos(p);addFiber(new e.Vector3($,h,y).normalize())}else if("icosahedral"===t){let f=(1+Math.sqrt(5))/2;for(let b of[[-1,f,0],[1,f,0],[-1,-f,0],[1,-f,0],[0,-1,f],[0,1,f],[0,-1,-f],[0,1,-f],[f,0,-1],[f,0,1],[-f,0,-1],[-f,0,1]]){let k=new e.Vector3(b[0],b[1],b[2]).normalize();addFiber(k)}}else if("longitude-bands"===t)for(let v=0;v<4;v++){let u=v/4*Math.PI*2,_=Math.cos(u),x=Math.sin(u);for(let E=0;E<40;E++){let w=(E/39+Math.PI/8)*Math.PI/2,I=Math.sin(w)*_,P=Math.sin(w)*x,M=Math.cos(w);addFiber(new e.Vector3(I,P,M).normalize())}}else if("equator-sine"===t)for(let B=0;B<200;B++){let L=B/200*Math.PI*2,S=Math.cos(L),F=Math.sin(L),z=.3*Math.sin(5*L);addFiber(new e.Vector3(S,F,z).normalize())}}scene.add(fibers);let raycaster=new e.Raycaster,mouse=new e.Vector2,selectedPoint=null,selectionMarker=document.getElementById("selection-marker");function onMouseMove(e){if(!sphereVisible){selectedPoint=null,selectionMarker.style.display="none";return}mouse.x=e.clientX/window.innerWidth*2-1,mouse.y=-(2*(e.clientY/window.innerHeight))+1,raycaster.setFromCamera(mouse,camera);let t=raycaster.intersectObject(sphere,!1)[0];if(t){selectedPoint=t.point.clone().normalize();let r=selectedPoint.clone();r.project(camera);let n=(.5*r.x+.5)*window.innerWidth,i=-(.5*r.y-.5)*window.innerHeight;selectionMarker.style.left=`${n}px`,selectionMarker.style.top=`${i}px`,selectionMarker.style.display="block"}else selectedPoint=null,selectionMarker.style.display="none"}function onKeyDown(e){("a"===e.key||"A"===e.key)&&selectedPoint&&(addFiber(selectedPoint),examplesDropdown.value="custom"),("h"===e.key||"H"===e.key)&&toggleControlsBtn.click(),("s"===e.key||"S"===e.key)&&saveCurrentView()}function checkScreenSize(){let e=document.getElementById("small-screen-message");window.innerWidth<410||window.innerHeight<610?e.style.display="flex":e.style.display="none"}function render(){controls.update(),renderer.setClearColor(725024,1),renderer.clear(!0,!0,!0),renderer.render(scene,camera),requestAnimationFrame(render)}function onResize(){renderer.setSize(window.innerWidth,window.innerHeight),camera.aspect=window.innerWidth/window.innerHeight,camera.updateProjectionMatrix()}window.addEventListener("mousemove",onMouseMove),window.addEventListener("keydown",onKeyDown),window.addEventListener("load",checkScreenSize),window.addEventListener("resize",checkScreenSize),window.addEventListener("load",()=>{let e=document.getElementById("loader");e.style.opacity="0",e.style.transition="opacity 0.5s ease",setTimeout(()=>e.style.display="none",500)}),render(),window.addEventListener("resize",onResize),addFiber(new e.Vector3(0,0,1)),addFiber(new e.Vector3(1,0,0).normalize()),addFiber(new e.Vector3(0,1,0).normalize());